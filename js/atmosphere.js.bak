/**
 * atmosphere.js
 * ACG æ”¶è—åº« - æ°›åœèˆ‡éŠæ¨™ç®¡ç†æ¨¡çµ„
 * åŒ…å«:
 * 1. CursorManager (éŠæ¨™) - ä¿ç•™
 * 2. PosterWall (æµ·å ±ç‰†) - å·²ç§»è‡³ poster-wall.js
 */

/* ==========================================
   Cursor Manager
   ========================================== */
window.CursorManager = {
    // è¨ˆç®—çµ•å°è·¯å¾‘ï¼Œç¢ºä¿ CSS è®Šæ•¸åœ¨å¤–éƒ¨æ¨£å¼è¡¨ä¸­ä½¿ç”¨æ™‚èƒ½æ­£ç¢ºè§£æ
    BASE_PATH: new URL('./assets/cursors', window.location.href).href,
    themes: {
        anya: {
            name: 'ğŸ¦Š é˜¿å°¼äº',
            folder: 'anya',
            files: {
                'default': 'default.gif',
                'pointer': 'pointer.gif',
                'text': 'text.gif',
                'help': 'help.gif',
                'wait': 'wait.gif',
                'move': 'move.gif',
                'not-allowed': 'not-allowed.gif',
                'resize-v': 'resize-v.gif',
                'resize-h': 'resize-h.gif',
                'resize-nwse': 'resize-nwse.gif',
                'resize-nesw': 'resize-nesw.gif'
            }
        },
        frieren: {
            name: 'ğŸ§™â€â™€ï¸ èŠ™è‰è“®',
            folder: 'frieren',
            files: {
                'default': 'default.gif',
                'pointer': 'pointer.gif',
                'text': 'text.gif',
                'help': 'help.gif',
                'wait': 'wait.gif',
                'move': 'move.gif',
                'not-allowed': 'not-allowed.gif',
                'resize-v': 'resize-v.gif',
                'resize-h': 'resize-h.gif',
                'resize-nwse': 'resize-nwse.gif',
                'resize-nesw': 'resize-nesw.gif'
            }
        },
        elysia: {
            name: 'ğŸ¦‹ æ„›è‰å¸Œé›…',
            folder: 'elysia',
            files: {
                'default': 'default.gif',
                'pointer': 'pointer.gif',
                'text': 'text.gif',
                'help': 'help.gif',
                'wait': 'wait.gif',
                'move': 'move.gif',
                'not-allowed': 'not-allowed.gif',
                'resize-v': 'resize-v.gif',
                'resize-h': 'resize-h.gif',
                'resize-nwse': 'resize-nwse.gif',
                'resize-nesw': 'resize-nesw.gif'
            }
        }
    },

    getThemeList() {
        return Object.keys(this.themes).map(key => ({
            id: key,
            name: this.themes[key].name
        }));
    },

    // VisualEngine Module Interface
    init(isLowSpec) {
        console.log('[CursorManager] Init...');

        // 1. å‰µå»ºè¦–è¦ºæ¸¸æ¨™å±¤ (Visual Cursor Layer)
        this.createVisualCursor();

        // 2. è¼‰å…¥å„²å­˜çš„è¨­å®š
        let savedTheme = localStorage.getItem('cursorTheme') || 'anya';
        let savedScale = localStorage.getItem('cursorScale') || '1';

        // 3. å¥—ç”¨è¨­å®š
        this.apply(savedTheme);
        this.setScale(savedScale);

        // 4. åŒæ­¥ UI
        this.syncUI(savedTheme, savedScale);

        // 5. ç¶å®šæ»‘é¼ è¿½è¹¤ (æ¡ç”¨å…¨å±€ç›£è½ä»¥ç¢ºä¿æ•ˆèƒ½)
        this.bindEvents();
    },

    createVisualCursor() {
        if (document.getElementById('custom-cursor-visual')) return;

        const cursor = document.createElement('div');
        cursor.id = 'custom-cursor-visual';
        // åŸºæœ¬æ¨£å¼ (å…¶é¤˜åœ¨ CSS ä¸­å®šç¾©)
        Object.assign(cursor.style, {
            position: 'fixed',
            pointerEvents: 'none',
            zIndex: '999999',
            width: '32px',
            height: '32px',
            backgroundSize: 'contain',
            backgroundRepeat: 'no-repeat',
            transformOrigin: 'top left', // è¨­å®šç¸®æ”¾åŸºæº–é»ç‚ºå·¦ä¸Šè§’
            transform: 'scale(1)',       // ç§»é™¤ translate(-5px)ï¼Œä¿æŒç†±é»ç²¾ç¢º
            display: 'none',
            willChange: 'transform, left, top'
        });
        document.body.appendChild(cursor);
        this.visualCursor = cursor;
    },

    bindEvents() {
        // å„ªåŒ–ï¼šä½¿ç”¨ ticking é¿å…é«˜é »è§¸ç™¼
        let ticking = false;
        let mouseX = 0;
        let mouseY = 0;

        // ç‹€æ…‹æ¨™è¨˜
        this.isHovering = true;
        this.isInIframe = false;

        document.addEventListener('mousemove', (e) => {
            if (!this.visualCursor) return;

            this.isHovering = true; // ç¢ºä¿ç‹€æ…‹æ­£ç¢º
            mouseX = e.clientX;
            mouseY = e.clientY;

            // Self-Healing: å¦‚æœæ»‘é¼ ç§»å‹•åˆ°äº†é iframe å€åŸŸï¼Œä½†ç‹€æ…‹ä»å¡åœ¨ isInIframeï¼Œå¼·åˆ¶ä¿®æ­£
            // é€™èƒ½é˜²æ­¢ mouseout äº‹ä»¶ä¸Ÿå¤±å°è‡´éŠæ¨™æ¶ˆå¤±æˆ–å¡ä½
            if (this.isInIframe && e.target && !e.target.closest('.detail-youtube, .yt-facade-v7, iframe')) {
                this.handleIframeLeave(e);
            }

            // æª¢æ¸¬ç›®å‰å…ƒç´ é¡å‹ä»¥åˆ‡æ›åœ–æ¨™ (éš¨æ™‚æª¢æ¸¬)
            this.updateCursorType(e.target);

            // å¦‚æœåœ¨ iframe å…§ï¼Œä¸åŸ·è¡Œä½ç½®æ›´æ–°ï¼Œé¿å…éŠæ¨™æ®˜å½±
            if (this.isInIframe) return;

            if (!ticking) {
                requestAnimationFrame(() => {
                    this.updateCursorPosition(mouseX, mouseY);
                    ticking = false;
                });
                ticking = true;
            }
        }, { passive: true });

        // è™•ç†æ¸¸æ¨™é›¢é–‹è¦–çª— (ç¶å®šæ–¼ documentElement ä»¥ç¢ºä¿æ˜¯è¦–çª—é‚Šç•Œ)
        document.documentElement.addEventListener('mouseleave', () => {
            this.hideCursor();
        });

        // è™•ç†æ¸¸æ¨™é€²å…¥è¦–çª—
        document.documentElement.addEventListener('mouseenter', (e) => {
            this.showCursor(e.clientX, e.clientY);
        });

        // é¡å¤–ä¿éšªï¼šç•¶è¦–çª—å¤±å»ç„¦é»æ™‚éš±è— (ä¾‹å¦‚ Alt-Tab)
        window.addEventListener('blur', () => {
            this.hideCursor();
        });

        // åˆå§‹åŒ–æ™‚ç¢ºä¿ class å­˜åœ¨
        document.documentElement.classList.add('custom-cursor-active');

        // 6. ç¶å®š iframe äº‹ä»¶
        this.bindIframeEvents();
    },

    bindIframeEvents() {
        // å®šç¾©åœ¨é€™ä»¥ä¾¿ç§»é™¤ç›£è½æ™‚å¼•ç”¨ç›¸åŒçš„å‡½æ•¸å¼•ç”¨
        this.handleIframeEnter = (e) => {
            // å¦‚æœç›®æ¨™æ˜¯è‡ªå®šç¾©è¦†è“‹å±¤ï¼Œå‰‡ä¸éš±è—éŠæ¨™ï¼ (é€™æ˜¯ Custom Player çš„é—œéµ)
            if (e.target && e.target.closest('.custom-video-overlay')) return;

            this.isInIframe = true;
            // éš±è—è‡ªå®šç¾©éŠæ¨™ï¼Œé‚„åŸåŸç”ŸéŠæ¨™ (è®“ä½¿ç”¨è€…å¯ä»¥æ“ä½œ iframe å…§å®¹)
            if (this.visualCursor) this.visualCursor.style.display = 'none';
            document.documentElement.classList.remove('custom-cursor-active');
        };

        this.handleIframeLeave = (e) => {
            // å¦‚æœå–®ç´”æ˜¯åœ¨ overlay å…§éƒ¨ç§»å‹•ï¼Œä¸è§¸ç™¼é›¢é–‹é‚è¼¯
            if (e.target && e.target.closest('.custom-video-overlay')) return;

            this.isInIframe = false;
            // é›¢é–‹ iframeï¼Œæ¢å¾©è‡ªå®šç¾©éŠæ¨™
            document.documentElement.classList.add('custom-cursor-active');
            if (this.visualCursor) this.visualCursor.style.display = 'block';
        };

        const attachListeners = (iframe) => {
            // å˜—è©¦ç¶å®šå®¹å™¨ (å¦‚æœæœ‰) æˆ– iframe æœ¬èº«
            const container = iframe.closest('.detail-youtube, .yt-facade-v7') || iframe;

            container.removeEventListener('mouseover', this.handleIframeEnter);
            container.removeEventListener('mouseout', this.handleIframeLeave);

            container.addEventListener('mouseover', this.handleIframeEnter);
            container.addEventListener('mouseout', this.handleIframeLeave);
        };

        // 1. è™•ç†ç¾æœ‰ iframe
        document.querySelectorAll('iframe').forEach(attachListeners);

        // 2. ç›£è½å‹•æ…‹æ–°å¢çš„ iframe
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                mutation.addedNodes.forEach((node) => {
                    if (node.tagName === 'IFRAME') {
                        attachListeners(node);
                    } else if (node.querySelectorAll) {
                        node.querySelectorAll('iframe').forEach(attachListeners);
                    }
                });
            });
        });

        observer.observe(document.body, { childList: true, subtree: true });
    },

    showCursor(x, y) {
        this.isHovering = true;
        if (this.visualCursor) {
            this.visualCursor.style.display = 'block';
            if (x !== undefined && y !== undefined) {
                this.visualCursor.style.left = `${x}px`;
                this.visualCursor.style.top = `${y}px`;
            }
            // ç¢ºä¿ class å­˜åœ¨
            if (!document.documentElement.classList.contains('custom-cursor-active')) {
                document.documentElement.classList.add('custom-cursor-active');
            }
        }
    },

    hideCursor() {
        this.isHovering = false;
        if (this.visualCursor) {
            this.visualCursor.style.display = 'none';
            // ä¸ç§»é™¤ custom-cursor-active classï¼Œä»¥å…åŸç”Ÿæ¸¸æ¨™åœ¨è¦–çª—å…§é–ƒçˆ
            // document.documentElement.classList.remove('custom-cursor-active');
        }
    },

    updateCursorPosition(x, y) {
        if (!this.visualCursor || !this.isHovering) return;

        this.visualCursor.style.left = `${x}px`;
        this.visualCursor.style.top = `${y}px`;

        // é›™é‡ä¿éšªï¼šç¢ºä¿é¡¯ç¤º
        if (this.visualCursor.style.display === 'none') {
            this.visualCursor.style.display = 'block';
        }
    },

    // å¼·åˆ¶éš±è—åŸç”ŸéŠæ¨™ä¸¦æ¢å¾©ç‹€æ…‹ (ç”¨æ–¼éå ´å‹•ç•«çµæŸå¾Œ)
    forceHideNativeCursor() {
        if (!document.documentElement.classList.contains('custom-cursor-active')) {
            document.documentElement.classList.add('custom-cursor-active');
        }
        if (this.visualCursor && this.visualCursor.style.display === 'none') {
            this.visualCursor.style.display = 'block';
        }
        this.isInIframe = false; // é‡ç½®ç‹€æ…‹
        console.log('[CursorManager] Force hid native cursor.');
    },

    updateCursorType(target) {
        if (!target) return;

        // åˆ¤æ–·æ˜¯å¦ç‚ºäº¤äº’å…ƒç´ 
        const isPointer = target.closest('a, button, select, .btn-primary, .anime-card, .clickable, [onclick], .custom-video-overlay');
        const isText = target.closest('input[type="text"], input[type="search"], textarea, .editable');
        const isHelp = target.closest('[title], .help');

        let type = 'default';
        if (isPointer) type = 'pointer';
        else if (isText) type = 'text';
        else if (isHelp) type = 'help';

        if (this.currentType !== type) {
            this.currentType = type;
            const theme = this.themes[localStorage.getItem('cursorTheme') || 'anya'];
            const url = `url('${this.buildPath(theme, theme.files[type])}')`;
            this.visualCursor.style.backgroundImage = url;

            // é‡å° pointer (æ‰‹æŒ‡) é¡å‹é€²è¡Œç†±é»æ ¡æ­£
            // å˜—è©¦çµ¦äºˆæŒ‡å°–ä¸€é»åç§» (å‡è¨­æ‰‹æŒ‡å°–ç«¯åœ¨åœ–ç‰‡ä¸­é–“åä¸Š)
            if (type === 'pointer') {
                this.visualCursor.style.transform = `translate(-6px, -2px) scale(${localStorage.getItem('cursorScale') || 1})`;
            } else {
                this.visualCursor.style.transform = `scale(${localStorage.getItem('cursorScale') || 1})`;
            }
        }
    },

    start() { },
    stop() { },
    resize() { },

    buildPath(theme, filename) {
        return `${this.BASE_PATH}/${theme.folder}/${filename}`;
    },

    apply(themeId) {
        if (!this.themes[themeId]) themeId = 'anya';
        localStorage.setItem('cursorTheme', themeId);

        const theme = this.themes[themeId];
        const root = document.documentElement;

        // 1. åŒæ™‚æ›´æ–° CSS è®Šæ•¸ (å‚™ç”¨) èˆ‡è¦–è¦ºæ¸¸æ¨™å±¤ (ä¸»ç”¨)
        Object.keys(theme.files).forEach(type => {
            const filename = theme.files[type];
            let fallback = 'auto';
            if (['pointer', 'text', 'help', 'wait', 'move'].includes(type)) fallback = type;
            else if (type === 'not-allowed') fallback = 'not-allowed';
            else if (type === 'resize-v') fallback = 'ns-resize';
            else if (type === 'resize-h') fallback = 'ew-resize';
            else if (type === 'resize-nwse') fallback = 'nwse-resize';
            else if (type === 'resize-nesw') fallback = 'nesw-resize';

            const cursorValue = `url('${this.buildPath(theme, filename)}'), ${fallback}`;
            root.style.setProperty(`--cur-${type}`, cursorValue);
        });

        // 2. æ›´æ–°ç•¶å‰è¦–è¦ºæ¸¸æ¨™åœ–æ¨™
        if (this.visualCursor) {
            const url = `url('${this.buildPath(theme, theme.files[this.currentType || 'default'])}')`;
            this.visualCursor.style.backgroundImage = url;
        }

        console.log(`[CursorManager] Applied theme: ${themeId}`);
    },

    setScale(scale) {
        const root = document.documentElement;
        root.style.setProperty('--cur-scale', scale);
        localStorage.setItem('cursorScale', scale);

        if (this.visualCursor) {
            // éœ€è¦ä¿æŒ updateCursorType ä¸­çš„åç§»é‚è¼¯
            if (this.currentType === 'pointer') {
                this.visualCursor.style.transform = `translate(-6px, -2px) scale(${scale})`;
            } else {
                this.visualCursor.style.transform = `scale(${scale})`;
            }
        }

        // æ›´æ–° UI æ–‡å­—æ¨™ç±¤
        const display = document.getElementById('cursor-size-display');
        if (display) display.textContent = parseFloat(scale).toFixed(1) + 'x';
    },

    // ä¾› HTML èª¿ç”¨çš„æ–°æ–¹æ³• (Stepper UI)
    changeScale(delta) {
        let current = parseFloat(localStorage.getItem('cursorScale') || '1');
        let newScale = current + delta;
        // é™åˆ¶ç¯„åœ 0.5 ~ 3.0
        if (newScale < 0.5) newScale = 0.5;
        if (newScale > 3.0) newScale = 3.0;

        this.setScale(newScale);
    },

    syncUI(theme, scale) {
        const select = document.getElementById('cursor-theme-select');
        if (select) select.value = theme;

        const display = document.getElementById('cursor-size-display');
        if (display) display.textContent = parseFloat(scale).toFixed(1) + 'x';
    }
};

// è¨»å†Šåˆ°å¼•æ“ - CursorManager
if (window.VisualEngine) {
    window.VisualEngine.register('CursorManager', window.CursorManager);
}

// Priority #1: ç«‹å³å•Ÿå‹•æ¸¸æ¨™ (ä¸ç­‰å¾… onload)
// å› ç‚º atmosphere.js ä½æ–¼ body åº•éƒ¨ï¼Œæ­¤æ™‚ body å·²å­˜åœ¨
if (document.body) {
    // ç«‹å³åŠ ä¸Š class ç¢ºä¿åŸç”Ÿæ¸¸æ¨™éš±è—
    document.documentElement.classList.add('custom-cursor-active');

    // ç«‹å³åˆå§‹åŒ–
    // æ³¨æ„ï¼šé€™è£¡å‡è¨­ isLowSpec ç‚º falseï¼Œå› ç‚ºé‚„æ²’åµæ¸¬æ€§èƒ½
    // ä½†æ¸¸æ¨™æ˜¯æ ¸å¿ƒé«”é©—ï¼Œæ‡‰å„ªå…ˆè¼‰å…¥
    window.CursorManager.init(false);
} else {
    // å‚™ç”¨ï¼šå¦‚æœè…³æœ¬è¢«ç§»å‹•åˆ° head
    document.addEventListener('DOMContentLoaded', () => {
        document.documentElement.classList.add('custom-cursor-active');
        window.CursorManager.init(false);
    });
}
