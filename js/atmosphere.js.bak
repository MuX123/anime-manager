/**
 * atmosphere.js - è™•ç†å…¨åŸŸå‹•æ…‹èƒŒæ™¯ï¼ˆç²’å­é€£ç·šç¶²çµ¡ï¼‰èˆ‡éŠæ¨™ç®¡ç†
 * ACG æ”¶è—åº« v8.0.0
 */

// ==========================================
// éŠæ¨™ç®¡ç†å™¨ (Cursor Manager)
// ==========================================
window.CursorManager = {
    themes: {
        cursor: { 
            name: 'ğŸ¯ Cursor é¢¨æ ¼', 
            folder: '.',  // æª”æ¡ˆåœ¨ assets/cursors/ æ ¹ç›®éŒ„
            files: {
                'pointer': '04_Point',
                'text': '05_Type',
                'move': '10_Move',
                'wait': '02_Loading',
                'help': '03_Question',
                'resize-v': '06_Vertical',
                'resize-h': '09_Horizontal',
                'resize-nwse': '07_LDiag',
                'resize-nesw': '08_RDiag',
                'default': '01_Normal'
            }
        },
        anya: { 
            name: 'ğŸ¦Š é˜¿å°¼äº', 
            folder: 'anya-forger',
            files: {
                'pointer': 'Link_Select',
                'text': 'Text_Select',
                'move': 'Move',
                'wait': 'Busy',
                'help': 'Help_Select',
                'resize-v': 'Vertical',
                'resize-h': 'Horizontal',
                'resize-nwse': 'Resize_1',
                'resize-nesw': 'resize_2',
                'default': 'Normal'
            }
        },
        elysia: { 
            name: 'ğŸ¦‹ æ„›è‰å¸Œé›…', 
            folder: 'elysia-honkai',
            files: {
                'pointer': 'Link',
                'text': 'Text',
                'move': 'Move',
                'wait': 'busy',
                'help': 'Help',
                'resize-v': 'Vertical',
                'resize-h': 'Horizontal',
                'resize-nwse': 'Diagonal1',
                'resize-nesw': 'Diagonal2',
                'default': 'Normal'
            }
        },
        frieren: { 
            name: 'ğŸ§™â€â™€ï¸ èŠ™è•¾è“®', 
            folder: 'frieren',
            files: {
                'pointer': 'Frieren link',
                'text': 'Frieren text',
                'move': 'Frieren move',
                'wait': 'Frieren busy',
                'help': 'Frieren help',
                'resize-v': 'Frieren vert',
                'resize-h': 'Frieren horz',
                'resize-nwse': 'Frieren dgn1',
                'resize-nesw': 'Frieren dgn2',
                'default': 'Frieren normal'
            }
        },
        miku: { 
            name: 'ğŸ¤ åˆéŸ³æœªä¾†', 
            folder: 'hatsune-miku',
            files: {
                'pointer': 'Link',
                'text': 'Text',
                'move': 'Move',
                'wait': 'Busy',
                'help': 'Help',
                'resize-v': 'Vertical',
                'resize-h': 'Horizontal',
                'resize-nwse': 'Diagonal1',
                'resize-nesw': 'Diagonal2',
                'default': 'Normal'
            }
        },
        nikke: { 
            name: 'ğŸ° NIKKE Doro', 
            folder: 'nikke-doro',
            files: {
                'pointer': 'doro_1',
                'text': 'doro_5',
                'move': 'doro_4',
                'wait': 'doro_3',
                'help': 'doro_2',
                'resize-v': 'doro_9',
                'resize-h': 'doro_8',
                'resize-nwse': 'doro_7',
                'resize-nesw': 'doro_6',
                'default': 'doro_10'
            }
        }
    },

    init() {
        const savedTheme = localStorage.getItem('cursorTheme') || 'cursor';
        this.apply(savedTheme);
    },

    apply(themeId) {
        if (!this.themes[themeId]) themeId = 'cursor';

        const theme = this.themes[themeId];
        const root = document.body;
        const basePath = `./assets/cursors/${theme.folder}`;

        console.log(`[CursorManager] å¥—ç”¨ä¸»é¡Œ: ${theme.name}`);

        // è¨­å®š CSS è®Šæ•¸
        const mapping = theme.files;
        const ext = '.ani';

        root.style.setProperty('--cur-pointer', `url('${basePath}/${mapping.pointer}${ext}'), pointer`);
        root.style.setProperty('--cur-finger', `url('${basePath}/${mapping.pointer}${ext}'), pointer`);
        root.style.setProperty('--cur-text', `url('${basePath}/${mapping.text}${ext}'), text`);
        root.style.setProperty('--cur-move', `url('${basePath}/${mapping.move}${ext}'), move`);
        root.style.setProperty('--cur-wait', `url('${basePath}/${mapping.wait}${ext}'), wait`);
        root.style.setProperty('--cur-help', `url('${basePath}/${mapping.help}${ext}'), help`);
        root.style.setProperty('--cur-resize-v', `url('${basePath}/${mapping['resize-v']}${ext}'), ns-resize`);
        root.style.setProperty('--cur-resize-h', `url('${basePath}/${mapping['resize-h']}${ext}'), ew-resize`);
        root.style.setProperty('--cur-resize-nwse', `url('${basePath}/${mapping['resize-nwse']}${ext}'), nwse-resize`);
        root.style.setProperty('--cur-resize-nesw', `url('${basePath}/${mapping['resize-nesw']}${ext}'), nesw-resize`);
        root.style.setProperty('--cur-default', `url('${basePath}/${mapping.default}${ext}'), default`);

        localStorage.setItem('cursorTheme', themeId);

        // ç™¼é€ Toast é€šçŸ¥
        if (window.showToast && document.visibilityState === 'visible') {
            window.showToast(`âœ¨ éŠæ¨™ä¸»é¡Œå·²åˆ‡æ›ï¼š${theme.name}`);
        }
    },

    getThemeList() {
        return Object.entries(this.themes).map(([id, data]) => ({
            id,
            name: data.name
        }));
    }
};

// å…¼å®¹èˆŠç‰ˆå‡½æ•¸å‘¼å«
window.changeCursorTheme = (theme) => window.CursorManager.apply(theme);
window.applyCursorTheme = (theme) => window.CursorManager.apply(theme);


// ==========================================
// å‹•æ…‹èƒŒæ™¯ (Digital Constellation / Particle Network)
// ==========================================
window.initAtmosphere = () => {
    try {
        console.log('[Atmosphere] åˆå§‹åŒ–æ˜Ÿç©ºé€£ç·šèƒŒæ™¯...');

        let container = document.getElementById('atmosphere-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'atmosphere-container';
            document.body.prepend(container);
        }

        // å‰µå»ºé®ç½©å±¤ - æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
        let overlay = document.getElementById('atmosphere-overlay');
        if (!overlay) {
            overlay = document.createElement('div');
            overlay.id = 'atmosphere-overlay';
            document.body.prepend(overlay);
        }

        // ç›£è½ animeData è¼‰å…¥å®Œæˆå¾Œæ¸²æŸ“èƒŒæ™¯
        const checkAndRender = () => {
            console.log('[Atmosphere] æª¢æŸ¥ animeData...', window.animeData ? window.animeData.length : 'undefined');
            
            if (window.animeData && window.animeData.length > 0) {
                console.log('[Atmosphere] æª¢æ¸¬åˆ° animeDataï¼Œé–‹å§‹æ¸²æŸ“èƒŒæ™¯...');
                
                // æ·»åŠ  flex æ¨£å¼ç¢ºä¿æ­£ç¢ºæ’åˆ—
                container.style.cssText = `
                    display: flex;
                    flex-wrap: wrap;
                    justify-content: center;
                    align-content: center;
                    gap: 15px;
                    padding: 40px;
                    opacity: 0;
                    transition: opacity 1.5s ease;
                `;
                
                // æ¸²æŸ“æµ·å ±ç‰†
                window.AtmosphereAPI.renderPosterWall();
                
                // æ·¡å…¥é¡¯ç¤º
                requestAnimationFrame(() => {
                    container.style.opacity = '0.6'; // èª¿ä½é€æ˜åº¦è®“çŸ©é™£é›¨é€å‡º
                });
                
                console.log('[Atmosphere] èƒŒæ™¯æ¸²æŸ“å®Œæˆ');
            } else {
                // æ¯ 100ms æª¢æŸ¥ä¸€æ¬¡ï¼Œç›´åˆ° animeData è¼‰å…¥å®Œæˆ
                setTimeout(checkAndRender, 100);
            }
        };

        // ç«‹å³é–‹å§‹æª¢æŸ¥
        checkAndRender();

        // å°å‡º API
        window.AtmosphereAPI = {
            pause: () => { container.style.opacity = '0'; },
            resume: () => { container.style.opacity = '1'; },
            setQuality: () => { },
            renderPosterWall: () => {
                if (!container) return;

                // é–å®šæ©Ÿåˆ¶ï¼šå¦‚æœå·²ç¶“æ¸²æŸ“éï¼Œå°±ä¸å†é‡æ–°æ¸²æŸ“
                if (container.getAttribute('data-locked') === 'true') {
                    return;
                }

                // éš¨æ©Ÿé¸å–æµ·å ±
                const posters = window.animeData
                    ?.filter(a => a.poster_url || a.image_url)
                    ?.map(a => a.poster_url || a.image_url) || [];

                if (posters.length === 0) {
                    console.warn('[Atmosphere] æ²’æœ‰æ‰¾åˆ°æµ·å ±è³‡æ–™');
                    return;
                }

                // è¨ˆç®—éœ€è¦çš„æµ·å ±æ•¸é‡
                const count = Math.min(24, posters.length * 2);
                let html = '';

                for (let i = 0; i < count; i++) {
                    const url = posters[Math.floor(Math.random() * posters.length)];
                    const delay = (Math.random() * 5).toFixed(1);
                    const duration = (15 + Math.random() * 10).toFixed(0);

                    html += `
                    <div class="poster-wall-item" style="animation-delay: -${delay}s;">
                        <div class="mech-cycle-img img-a" style="background-image: url('${url}'); animation-duration: ${duration}s; animation-delay: -${delay}s;"></div>
                        <div class="mech-cycle-img img-b" style="background-image: url('${url}'); animation-duration: ${duration}s; animation-delay: -${delay}s;"></div>
                        <div class="mech-cycle-img img-c" style="background-image: url('${url}'); animation-duration: ${duration}s; animation-delay: -${delay}s;"></div>
                    </div>`;
                }
                
                container.innerHTML = html + container.innerHTML; // ä¿ç•™å…‰æ–‘
                container.setAttribute('data-locked', 'true');
                console.log('[Atmosphere] èƒŒæ™¯å·²ç”Ÿæˆ (Mechanical Cycle Mode)');
            },
            refresh: () => {
                container.removeAttribute('data-locked');
                window.AtmosphereAPI.renderPosterWall();
            }
        };

    } catch (e) {
        console.error('[Atmosphere] åˆå§‹åŒ–å¤±æ•—:', e);
    }
};

// ==========================================
// åˆå§‹åŒ–åŸ·è¡Œ (ç­‰å¾… DOM å’Œæ•¸æ“šè¼‰å…¥)
// ==========================================
// å»¶é²åŸ·è¡Œï¼Œç¢ºä¿ animeData å·²è¼‰å…¥
window.addEventListener('load', () => {
    setTimeout(() => {
        window.initAtmosphere();
        window.CursorManager.init();
    }, 200);
});
