/**
 * atmosphere.js - è™•ç†å…¨åŸŸå‹•æ…‹èƒŒæ™¯ï¼ˆç²’å­é€£ç·šç¶²çµ¡ï¼‰èˆ‡éŠæ¨™ç®¡ç†
 * ACG æ”¶è—åº« v8.0.1
 */

// ==========================================
// éŠæ¨™ç®¡ç†å™¨ (Cursor Manager) - é‡æ§‹ç‰ˆ
// ==========================================
window.CursorManager = {
    // çµ•å°è·¯å¾‘å‰ç¶´
    BASE_PATH: '/assets/cursors',
    
    // ä¸»é¡Œé…ç½® - ä½¿ç”¨çœŸå¯¦å­˜åœ¨çš„æª”æ¡ˆåç¨±
    themes: {
        cursor: {
            name: 'ðŸŽ¯ Cursor é¢¨æ ¼',
            folder: '.',
            files: {
                'pointer': '04_Point.ani',
                'text': '05_Type.ani',
                'move': '10_Move.ani',
                'wait': '02_Loading.ani',
                'help': '03_Question.ani',
                'resize-v': '06_Vertical.ani',
                'resize-h': '09_Horizontal.ani',
                'resize-nwse': '07_LDiag.ani',
                'resize-nesw': '08_RDiag.ani',
                'default': '01_Normal.ani'
            }
        },
        anya: {
            name: 'ðŸ¦Š é˜¿å°¼äºž',
            folder: 'anya-forger',
            files: {
                'pointer': 'Link_Select.ani',
                'text': 'Text_Select.ani',
                'move': 'Move.ani',
                'wait': 'Busy.ani',
                'help': 'Help_Select.ani',
                'resize-v': 'Vertical.ani',
                'resize-h': 'Horizontal.ani',
                'resize-nwse': 'Resize_1.ani',
                'resize-nesw': 'resize_2.ani',
                'default': 'Normal.ani'
            }
        },
        elysia: {
            name: 'ðŸ¦‹ æ„›èŽ‰å¸Œé›…',
            folder: 'elysia-honkai',
            files: {
                'pointer': 'Link.ani',
                'text': 'Text.ani',
                'move': 'Move.ani',
                'wait': 'busy.ani',
                'help': 'Help.ani',
                'resize-v': 'Vertical.ani',
                'resize-h': 'Horizontal.ani',
                'resize-nwse': 'Diagonal1.ani',
                'resize-nesw': 'Diagonal2.ani',
                'default': 'Normal.ani'
            }
        },
        frieren: {
            name: 'ðŸ§™â€â™€ï¸ èŠ™è•¾è“®',
            folder: 'frieren',
            files: {
                'pointer': 'Frieren link.ani',
                'text': 'Frieren text.ani',
                'move': 'Frieren move.ani',
                'wait': 'Frieren busy.ani',
                'help': 'Frieren help.ani',
                'resize-v': 'Frieren vert.ani',
                'resize-h': 'Frieren horz.ani',
                'resize-nwse': 'Frieren dgn1.ani',
                'resize-nesw': 'Frieren dgn2.ani',
                'default': 'Frieren normal.ani'
            }
        },
        miku: {
            name: 'ðŸŽ¤ åˆéŸ³æœªä¾†',
            folder: 'hatsune-miku',
            files: {
                'pointer': 'Link.ani',
                'text': 'Text.ani',
                'move': 'Move.ani',
                'wait': 'Busy.ani',
                'help': 'Help.ani',
                'resize-v': 'Vertical.ani',
                'resize-h': 'Horizontal.ani',
                'resize-nwse': 'Diagonal1.ani',
                'resize-nesw': 'Diagonal2.ani',
                'default': 'Normal.ani'
            }
        },
        nikke: {
            name: 'ðŸ° NIKKE Doro',
            folder: 'nikke-doro',
            files: {
                'pointer': 'doro_1.ani',
                'text': 'doro_5.ani',
                'move': 'doro_4.ani',
                'wait': 'doro_3.ani',
                'help': 'doro_2.ani',
                'resize-v': 'doro_9.ani',
                'resize-h': 'doro_8.ani',
                'resize-nwse': 'doro_7.ani',
                'resize-nesw': 'doro_6.ani',
                'default': 'doro_10.ani'
            }
        }
    },
    
    // é©—è­‰æª”æ¡ˆæ˜¯å¦å­˜åœ¨
    async verifyFile(url) {
        try {
            const response = await fetch(url, { method: 'HEAD' });
            return response.ok;
        } catch (error) {
            console.warn(`[CursorManager] æª”æ¡ˆä¸å­˜åœ¨: ${url}`);
            return false;
        }
    },
    
    // æ§‹å»ºå®Œæ•´è·¯å¾‘
    buildPath(theme, filename) {
        if (theme.folder === '.') {
            return `${this.BASE_PATH}/${filename}`;
        }
        return `${this.BASE_PATH}/${theme.folder}/${filename}`;
    },
    
    // ç²å–å¸¶æœ‰å›žé€€çš„ cursor URL
    async getCursorUrl(theme, type) {
        const filename = theme.files[type] || theme.files['default'];
        const primaryPath = this.buildPath(theme, filename);
        
        if (await this.verifyFile(primaryPath)) {
            return primaryPath;
        }
        
        const curFilename = filename.replace('.ani', '.cur');
        const curPath = this.buildPath(theme, curFilename);
        
        if (await this.verifyFile(curPath)) {
            return curPath;
        }
        
        console.warn(`[CursorManager] ç„¡æ³•è¼‰å…¥ ${type}ï¼Œä½¿ç”¨ç³»çµ±æ¸¸æ¨™`);
        return null;
    },
    
    // åˆå§‹åŒ–
    async init() {
        console.log('[CursorManager] åˆå§‹åŒ–...');
        const savedTheme = localStorage.getItem('cursorTheme') || 'cursor';
        await this.apply(savedTheme);
    },
    
    // å¥—ç”¨ä¸»é¡Œ
    async apply(themeId) {
        console.log(`[CursorManager] å¥—ç”¨ä¸»é¡Œ: ${themeId}`);
        
        if (!this.themes[themeId]) {
            console.warn(`[CursorManager] ä¸»é¡Œä¸å­˜åœ¨: ${themeId}ï¼Œä½¿ç”¨é è¨­`);
            themeId = 'cursor';
        }
        
        const theme = this.themes[themeId];
        
        try {
            const cursorTypes = ['pointer', 'text', 'move', 'wait', 'help', 'resize-v', 'resize-h', 'resize-nwse', 'resize-nesw', 'default'];
            const cursorPromises = cursorTypes.map(async (type) => {
                const url = await this.getCursorUrl(theme, type);
                return { type, url };
            });
            
            const results = await Promise.all(cursorPromises);
            
            const root = document.documentElement;
            
            for (const { type, url } of results) {
                const varName = `--cur-${type}`;
                const cursorValue = url ? `url('${url}'), auto` : 'auto';
                root.style.setProperty(varName, cursorValue);
            }
            
            localStorage.setItem('cursorTheme', themeId);
            
            console.log(`[CursorManager] ä¸»é¡Œå¥—ç”¨æˆåŠŸ: ${theme.name}`);
            
            if (window.showToast && document.visibilityState === 'visible') {
                window.showToast(`âœ¨ éŠæ¨™ä¸»é¡Œå·²åˆ‡æ›ï¼š${theme.name}`);
            }
            
        } catch (error) {
            console.error('[CursorManager] å¥—ç”¨ä¸»é¡Œå¤±æ•—:', error);
        }
    },
    
    getThemeList() {
        return Object.entries(this.themes).map(([id, data]) => ({
            id,
            name: data.name
        }));
    }
};

window.changeCursorTheme = (theme) => window.CursorManager.apply(theme);
window.applyCursorTheme = (theme) => window.CursorManager.apply(theme);


// ==========================================
// å‹•æ…‹èƒŒæ™¯ (Digital Constellation / Particle Network)
// ==========================================
window.initAtmosphere = () => {
    try {
        console.log('[Atmosphere] åˆå§‹åŒ–æ˜Ÿç©ºé€£ç·šèƒŒæ™¯...');

        let container = document.getElementById('atmosphere-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'atmosphere-container';
            document.body.prepend(container);
        }

        let overlay = document.getElementById('atmosphere-overlay');
        if (!overlay) {
            overlay = document.createElement('div');
            overlay.id = 'atmosphere-overlay';
            document.body.prepend(overlay);
        }

        const checkAndRender = () => {
            console.log('[Atmosphere] æª¢æŸ¥ animeData...', window.animeData ? window.animeData.length : 'undefined');
            
            if (window.animeData && window.animeData.length > 0) {
                console.log('[Atmosphere] æª¢æ¸¬åˆ° animeDataï¼Œé–‹å§‹æ¸²æŸ“èƒŒæ™¯...');
                
                container.style.cssText = `
                    display: flex;
                    flex-wrap: wrap;
                    justify-content: center;
                    align-content: center;
                    gap: 15px;
                    padding: 40px;
                    opacity: 0;
                    transition: opacity 1.5s ease;
                `;
                
                window.AtmosphereAPI.renderPosterWall();
                
                requestAnimationFrame(() => {
                    container.style.opacity = '0.6';
                });
                
                console.log('[Atmosphere] èƒŒæ™¯æ¸²æŸ“å®Œæˆ');
            } else {
                setTimeout(checkAndRender, 100);
            }
        };

        checkAndRender();

        window.AtmosphereAPI = {
            pause: () => { container.style.opacity = '0'; },
            resume: () => { container.style.opacity = '1'; },
            setQuality: () => { },
            renderPosterWall: () => {
                if (!container) return;

                if (container.getAttribute('data-locked') === 'true') {
                    return;
                }

                const posters = window.animeData
                    ?.filter(a => a.poster_url || a.image_url)
                    ?.map(a => a.poster_url || a.image_url) || [];

                if (posters.length === 0) {
                    console.warn('[Atmosphere] æ²’æœ‰æ‰¾åˆ°æµ·å ±è³‡æ–™');
                    return;
                }

                const count = Math.min(24, posters.length * 2);
                let html = '';

                for (let i = 0; i < count; i++) {
                    const url = posters[Math.floor(Math.random() * posters.length)];
                    const delay = (Math.random() * 5).toFixed(1);
                    const duration = (15 + Math.random() * 10).toFixed(0);

                    html += `
                    <div class="poster-wall-item" style="animation-delay: -${delay}s;">
                        <div class="mech-cycle-img img-a" style="background-image: url('${url}'); animation-duration: ${duration}s; animation-delay: -${delay}s;"></div>
                        <div class="mech-cycle-img img-b" style="background-image: url('${url}'); animation-duration: ${duration}s; animation-delay: -${delay}s;"></div>
                        <div class="mech-cycle-img img-c" style="background-image: url('${url}'); animation-duration: ${duration}s; animation-delay: -${delay}s;"></div>
                    </div>`;
                }
                
                container.innerHTML = html + container.innerHTML;
                container.setAttribute('data-locked', 'true');
                console.log('[Atmosphere] èƒŒæ™¯å·²ç”Ÿæˆ (Mechanical Cycle Mode)');
            },
            refresh: () => {
                container.removeAttribute('data-locked');
                window.AtmosphereAPI.renderPosterWall();
            }
        };

    } catch (e) {
        console.error('[Atmosphere] åˆå§‹åŒ–å¤±æ•—:', e);
    }
};

window.addEventListener('load', () => {
    setTimeout(() => {
        window.initAtmosphere();
        window.CursorManager.init();
    }, 200);
});
