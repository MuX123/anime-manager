<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†æåŠŸèƒ½æ¸¬è©¦</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>åˆ†æåŠŸèƒ½æ¸¬è©¦é é¢</h1>
    <div id="analytics-display" style="background: #f0f0f0; padding: 10px; margin: 10px 0;">
        è¼‰å…¥ä¸­...
    </div>
    <button onclick="testClickTracking()">æ¸¬è©¦é»æ“Šè¿½è¹¤</button>
    <button onclick="testVisitTracking()">æ¸¬è©¦è¨ªå•è¿½è¹¤</button>
    <button onclick="loadAnalytics()">é‡æ–°è¼‰å…¥çµ±è¨ˆ</button>
    
    <div id="test-results"></div>

    <script>
        // åˆå§‹åŒ– Supabase å®¢æˆ¶ç«¯
        const supabaseUrl = 'https://twgydqknzdyahgfuamak.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR3Z3lkcWtuemR5YWhnZnVhbWFrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NjA5MTEsImV4cCI6MjA4NDMzNjkxMX0.0YizCZP2OglEQQIh96x8viaemR6reZs8zendNT9KS7c';
        const client = window.supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
        
        let analyticsData = { totalClicks: 0, uniqueVisitors: 0 };

        function getVisitorId() {
            let visitorId = localStorage.getItem('visitor_id');
            if (!visitorId) {
                visitorId = 'v_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('visitor_id', visitorId);
            }
            return visitorId;
        }

        async function testClickTracking() {
            try {
                const visitorId = getVisitorId();
                const result = await client
                    .from('category_clicks')
                    .insert([{ 
                        visitor_id: visitorId,
                        category_name: 'test',
                        page_url: window.location.href,
                        click_timestamp: new Date().toISOString()
                    }]);
                
                updateResults('âœ… é»æ“Šè¿½è¹¤æ¸¬è©¦æˆåŠŸ: ' + JSON.stringify(result));
                setTimeout(loadAnalytics, 1000); // å»¶é²è¼‰å…¥çµ±è¨ˆ
            } catch (err) {
                updateResults('âŒ é»æ“Šè¿½è¹¤æ¸¬è©¦å¤±æ•—: ' + err.message);
            }
        }

        async function testVisitTracking() {
            try {
                const visitorId = getVisitorId();
                const lastTrack = localStorage.getItem('last_visit_time');
                const now = Date.now();
                
                if (!lastTrack || (now - parseInt(lastTrack)) >= 300000) {
                    // è¨˜éŒ„é é¢è¨ªå•
                    await client
                        .from('page_views')
                        .insert([{ 
                            visitor_id: visitorId,
                            page_url: window.location.href,
                            page_title: document.title,
                            view_timestamp: new Date().toISOString()
                        }]);
                    
                    localStorage.setItem('last_visit_time', now.toString());
                    updateResults('âœ… è¨ªå•è¿½è¹¤æ¸¬è©¦æˆåŠŸ');
                } else {
                    updateResults('â° 5åˆ†é˜å…§é‡è¤‡è¨ªå•ï¼Œè·³éè¨˜éŒ„');
                }
                
                setTimeout(loadAnalytics, 1000);
            } catch (err) {
                updateResults('âŒ è¨ªå•è¿½è¹¤æ¸¬è©¦å¤±æ•—: ' + err.message);
            }
        }

        async function loadAnalytics() {
            try {
                const [clicksResult, visitorsResult] = await Promise.all([
                    client.from('category_clicks').select('id', { count: 'exact', head: true }),
                    client.from('site_visitors').select('visitor_id', { count: 'exact', head: true })
                ]);
                
                analyticsData.totalClicks = clicksResult.count || 0;
                analyticsData.uniqueVisitors = visitorsResult.count || 0;
                
                updateAnalyticsDisplay();
                updateResults('âœ… çµ±è¨ˆæ•¸æ“šè¼‰å…¥æˆåŠŸ');
            } catch (err) {
                updateResults('âŒ çµ±è¨ˆæ•¸æ“šè¼‰å…¥å¤±æ•—: ' + err.message);
            }
        }

        function updateAnalyticsDisplay() {
            const container = document.getElementById('analytics-display');
            if (container) {
                container.innerHTML = `
                    <span style="margin-right: 15px;">ğŸ–±ï¸ é»æ“Šæ¬¡æ•¸: ${analyticsData.totalClicks.toLocaleString()}</span>
                    <span>ğŸ‘¤ è¨ªå®¢äººæ•¸: ${analyticsData.uniqueVisitors.toLocaleString()}</span>
                `;
            }
        }

        function updateResults(message) {
            const resultsDiv = document.getElementById('test-results');
            const timestamp = new Date().toLocaleTimeString();
            resultsDiv.innerHTML += `<div>[${timestamp}] ${message}</div>`;
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•è¼‰å…¥çµ±è¨ˆ
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(loadAnalytics, 1000);
        });
    </script>
</body>
</html>